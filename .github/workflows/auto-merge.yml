name: CI - Quality Gate & Auto Merge

on:
  push:
    branches:
      - 'feat/**'

permissions:
  contents: write

jobs:
  # JOB 1: BACKEND QUALITY ASSURANCE
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start MongoDB Container
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '6.0'
          mongodb-replica-set: rs0

      - name: Install & Seed Backend
        run: |
          cd server
          npm ci
          echo "PORT=5000" >> .env
          echo "MONGO_URI=mongodb://localhost:27017/credia_db" >> .env
          echo "JWT_SECRET=ci_test_secret" >> .env
          node src/seeder.js

      - name: Run Backend Tests
        run: |
          cd server
          npm start &
          sleep 5
          node tests/run_all.js

  # JOB 2: FRONTEND QUALITY ASSURANCE (NEW)
  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Frontend Dependencies
        run: |
          cd client
          npm ci

      - name: Run Frontend Unit Tests
        run: |
          cd client
          npm test

      - name: Build Frontend (Check for Compilation Errors)
        run: |
          cd client
          npm run build

  # JOB 3: AUTO MERGE
  # Only runs if BOTH backend-test AND frontend-test pass
  merge-to-dev:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure CI Bot
        run: |
          git config --global user.name "Credia CI Bot"
          git config --global user.email "ci-bot@credia.system"

      - name: Merge to Dev
        run: |
          git fetch --all
          git checkout dev
          git pull origin dev
          echo "Merging ${{ github.ref_name }} into dev..."
          git merge origin/${{ github.ref_name }} --no-ff -m "chore(ci): auto-merge ${{ github.ref_name }} into dev [skip ci]"
          git push origin dev